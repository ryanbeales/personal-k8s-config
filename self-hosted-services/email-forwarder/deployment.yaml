apiVersion: apps/v1
kind: Deployment
metadata:
  name: email-forwarder
  namespace: ryanbeales-com
spec:
  replicas: 1
  selector:
    matchLabels:
      app: email-forwarder
  template:
    metadata:
      labels:
        app: email-forwarder
    spec:
      containers:
        - name: forwarder
          image: python:3.11-slim
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
            requests:
              cpu: 10m
              memory: 64Mi
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Installing dependencies..."
              pip install boto3 --quiet
              echo "Dependencies installed. Starting forwarder..."
              python -u /scripts/forwarder.py
          env:
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: ryanbeales-email-forwarder-creds
                  key: username
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: ryanbeales-email-forwarder-creds
                  key: password
            - name: AWS_REGION
              value: us-west-2
            - name: SQS_QUEUE_URL
              value: "https://sqs.us-west-2.amazonaws.com/645775182778/ryanbeales-com-ses-forwarder"
            - name: DESTINATION_EMAIL
              valueFrom:
                secretKeyRef:
                  name: email-forwarder-config
                  key: destination_email
            - name: FORK_FROM_EMAIL
              value: "forwarder@ryanbeales.com"
          volumeMounts:
            - name: scripts
              mountPath: /scripts
      volumes:
        - name: scripts
          configMap:
            name: email-forwarder-script
